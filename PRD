PRD: Kitchen Chaos A/V Story (Web)

1) Summary and vision
- Purpose: An interactive, comedic audio-visual piece where ordinary cooking escalates into chaos. Users trigger most sounds via pointer actions; accidents trigger themselves as the story advances. Visuals are playful, candy-pastel abstractions. The story ends at peak chaos with a hard audio cut after 30 seconds in Chaos. Visual end treatment will be handled separately.
- Platforms: Desktop and mobile browsers, both orientations.
- Stack: Pure frontend (HTML/CSS/JS), Three.js for visuals, Web Audio API for sound. Static hosting.
- Inputs: Pointer only (click/drag/hold).
- Performance: Full devicePixelRatio. Optimize later; keep architecture perf-friendly.

2) Success criteria
- Users can naturally discover actions via brief, comedic prompts.
- The four narrative states occur in order via sequencer cues (no time/metric-based transitions).
- Accidents and other events are triggered deterministically through the sequencer and user actions.
- Sound and visual pairings feel coherent and comedic; panning matches on-screen x-position.
- UI narrative appears bottom-center as short captions.

3) Assets (final samples; in-app gain/speed/fades allowed)
- File naming convention: All filenames use underscores instead of spaces (e.g., "bag_rustling.ogg" not "bag rustling.ogg") for consistent URL handling.
- Asset path: Files are served from `/assets/audio/` (absolute path from server root).
- bag_rustling.ogg
- boiling_water.ogg
- chopping.ogg
- clatter.ogg
- cooking_spray.ogg
- cutting_things.ogg
- fire_alarm.ogg
- fridge.ogg
- glass_clink.ogg
- glass_stirring.ogg
- hissing_pan.ogg
- knife_sharpen.ogg
- lighter.ogg
- microwave.ogg
- objects_falling.ogg
- pot_falling.ogg
- squeeze_juice.ogg
- stove.ogg
- stove_fire.ogg
- tap.ogg
- thump.ogg
- water_pour.ogg

4) Sound triggering model (simplified)
- Two playback modalities, determined by sequence actions:
  - One-shot: `playOneShot`
  - Looped: `startSustained` / `stopSustained` / `toggleSustained`
- Sound entries have no `type` field. Author behavior via per-state `sequence` actions.

5) Narrative structure and FSM
- States: Preparing → Cooking → Accident Breakout → Chaos. Transitions are driven exclusively by sequencer cues (`gotoState`).
- No meters or time-based transitions. Any conditional logic references simple FSM flags (e.g., `stoveOn`).
- Accidents and alarms are included as cues within state sequences.

5.1 Per-state sound programming (current build)
- Preparing: `fridge`, `knife_sharpen` (drag), `chopping`, `cutting_things`, `squeeze_juice` (hold), `tap`, `bag_rustling`
- Cooking: `lighter`, `stove` (looped), `stove_fire`, `hissing_pan` (looped, requires `stoveOn`), `water_pour` (drag), `glass_stirring` (hold), `cooking_spray` (hold), `microwave`, `glass_clink`, `boiling_water` (looped, requires `stoveOn`)
- Accident Breakout: `clatter`, `pot_falling`, `objects_falling`, `thump`
- Chaos: `fire_alarm` (looped), `clatter`, `pot_falling`, `thump`
  - During Chaos, the FX bus delay wet mix ramps up gradually across the state (approx. 0.1 → 0.9 over ~30 s) creating an increasingly echoic space.

6) Interaction grammar (sequencer-gated)
- Click anywhere: advances only if the immediate next cue is eligible for `click`.
- Hold start: advances only if the immediate next cue declares `requires: "hold"`.
- Drag start: advances only if the immediate next cue declares `requires: "drag"`.
- Cues may optionally include simple conditions (e.g., `if: { "stoveOn": true }`).
- The sequencer does not skip ahead on mismatched input or unmet conditions.

7) Visual language (candy pastels; examples and parameters)
- Shared visual API (factory output):
  - create(params) → { id, setParams(newParams), update(audioData, dt), setPosition(x,y), getPosition(), destroy() }
  - Common params: colorA/B, size, lifespanMs, spawnJitter, orbitRadius, speed, angle, bandLowHz, bandHighHz, responseGain, opacity, blendMode, strokeWidth.
- Mappings per sound
  - water pour: ribbonWave; blue/aqua ribbon traveling down; amplitude from 200–800 Hz band; follows drag path; lifespan short (1–2 s).
  - fire alarm: flashingCircularSpectrogram; red pastel; flash 4 Hz; orbits canvas center with small jitter; radius modulated by overall RMS; moves during Chaos.
  - chopping/cutting: pulseStrokes; white pulses at pointer, stroke width from onset strength; lifespan 300–500 ms.
  - bag rustling: polygonWrinkle; quick crumple near cursor; 400–600 ms.
  - glass clink: starburstShards; crystalline burst; 500–800 ms.
  - lighter: flare + heat shimmer; 300–500 ms.
  - stove: heatRing + shimmer; ring intensity from RMS; static at spawn x.
  - hissing_pan: steamParticles; emission rate from high bands; stationary.
  - boiling_water: bubbleField; bubble size from 150–500 Hz; stationary.
  - tap: rippleEmitter; ripples expand; low-mid energy drives amplitude.
  - glass stirring: vortexSpiral; swirl rate from pointer angular velocity; sustained while held.
  - cooking spray: sprayCone; particle density from RMS; sustained while held.
  - knife sharpen: sparkLine; spark rate from mid-high band.
  - juicing: citrusSplash; droplets outward; sustained while held.
  - microwave: microwaveGrid; pulsing squares; one-shot visual matching sample length.
  - clatter/objects falling/pot falling/thump: accidents; screen shake + bursts; random positions; 500–1200 ms visuals.
  - stove_fire: brief flareHeat burst from burner; 200–400 ms.

8) Audio model
- Defaults: gain 0 dB, playbackRate 1.0, fadeIn 15 ms, fadeOut 30 ms (short fades to avoid clicks; does not affect one-shot length noticeably).
- Web Audio routing per entity: BufferSource → GainNode → StereoPannerNode → BusGain → MasterCompressor → MasterLimiter → destination.
- FX/Accidents processing: The `fx` and `accidents` buses share a delay insert with wet/dry mix and feedback.
  - Chain: (fx + accidents) → [dry path] + [delay → wet path] → master.
  - Defaults: delayTime ≈ 250 ms, feedback ≈ 0.35, wet mix 0.0 outside Chaos.
  - Scope: `beds` remain dry; both `fx` and `accidents` are affected by the delay.
- Panning: pan = map(xNormalized ∈ [0..1]) to [-1..1]. Update if the visual moves (e.g., alarm orbit).
- Build-ups: sustained loops (boiling/hissing) can ramp gain over 1–3 s on start.
- Concurrency: no hard cap; rely on compressor/limiter to prevent clipping.
- Audio unlock: create/resume AudioContext on first user interaction; preload decode all buffers.

9) Accidents
- Accidents (`clatter`, `pot_falling`, `objects_falling`, `thump`) are sequenced as cues within Accident Breakout and Chaos. No background scheduler.

10) Spawn rules and motion
- User-transient: spawn at cursor/touch; short-lived visual near position.
- User-sustained: spawn at cursor; generally stationary unless design notes say otherwise.
- Accidents: spawn at designed positions or center as visuals dictate.
- Fire alarm: sustained; visual can be stationary or lightly animated (no required orbit).

11) UI prompts (comedic, minimal)
- Preparing: “Maybe light something.”
- Cooking: “Multitasking is easy. Add more. More.”
- Accident Breakout: “It’s fine. Totally fine.”
- Chaos: “Nailed it.”
- Display bottom-center as small captions; fade in/out around state changes.
 - Cue text style: In Preparing/Cooking, texts are friendly hints about what the user will do next. In Accident Breakout/Chaos, texts describe what just happened (event narration), not predictions.

12) Error handling and edge cases
- If AudioContext fails to start, display a tap-to-start overlay.
- If a required dependency fails (e.g., WebGL), fallback message: “Needs WebGL/Audio enabled.”
- Buffer loading: Graceful degradation - if a buffer fails to decode or fetch, log a warning and continue loading other buffers. The failed sound will be skipped during playback (returns null) rather than crashing the app.
- Individual sound failures don't block the experience; only missing critical dependencies (WebGL, AudioContext) prevent startup.

13) Logging (console-only)
- Toggle: debug=true in a top-level config flag or URL param (?debug=1).
- Event types and payloads
  - app:init, app:assets_loaded
  - audio:context_unlocked, audio:chaos_cut
  - state:enter {state, t}
  - state:goto {to, from}
  - user:action {type, x, y}
  - sound:play|start|stop|toggle {id, action, state, index}
  - error:{code,msg}
- Include a monotonically increasing event id and session id; include current state in each log.

14) Acceptance criteria
- Audio panning matches visual x within one animation frame latency.
- States occur in correct order via sequencer cues.
- All listed sounds are reachable via click/hold/drag per sequences.
- Chaos ends at ~30 s with a hard audio cut (visual end treatment TBD).
- Works on recent Chrome/Safari/Firefox mobile and desktop; first interaction unlocks audio.

15) Data-driven configuration

15.1 JSON schema (authoring)
- meta: version, debug, palette.
- sounds: array of sound configs; each references a visual factory and bus. Filenames use underscores and are served from `/assets/audio/`.
- fsm: initialState, states with `enterActions` and a linear `sequence` of cues. Supported cue actions: `playOneShot`, `startSustained`, `stopSustained`, `toggleSustained`, `gotoState`. Optional cue fields: `requires` ("click"|"hold"|"drag"), `if` (simple equality on FSM flags), `fsm` (e.g., `{ "setStove": true }`).

15.2 Implementation notes
- Path resolution: All asset paths use absolute paths from server root (e.g., `/assets/audio/stove.ogg`).
- Visual factories implemented: heatRing, ribbonWave, accidentBursts, flashingCircularSpectrogram, pulseStrokes, polygonWrinkle, starburstShards, flareHeat, steamParticles, bubbleField, rippleEmitter, vortexSpiral, sprayCone, sparkLine, citrusSplash, microwaveGrid.
- Sound mapping: Each sound entry in config includes: id, file, visual, bus. Behavior is determined by `sequence` actions.

Example minimal schema:
{
  "meta": { "version": 1, "debug": true, "palette": "candyPastels" },
  "sounds": [ { "id": "stove", "file": "stove.ogg", "visual": "heatRing", "bus": "beds" } ],
  "fsm": {
    "initialState": "Preparing",
    "states": [
      {
        "name": "Preparing",
        "enterActions": [{ "type": "uiPrompt", "text": "Maybe light something." }],
        "sequence": [
          { "action": "playOneShot", "sound": "fridge" },
          { "action": "gotoState", "to": "Cooking" }
        ]
      }
    ]
  }
}